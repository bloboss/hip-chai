# Dockerfile for testing CHAI HIP benchmarks compilation
# This is a development/testing focused container with all build tools

FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Set ROCm version
ARG ROCM_VERSION=6.0
ENV ROCM_VERSION=${ROCM_VERSION}

# Install basic dependencies
RUN apt-get update && apt-get install -y \
    wget \
    gnupg2 \
    software-properties-common \
    ca-certificates \
    curl \
    git \
    make \
    cmake \
    build-essential \
    vim \
    nano \
    gdb \
    valgrind \
    python3 \
    python3-pip \
    time \
    htop \
    && rm -rf /var/lib/apt/lists/*

# Add ROCm repository
RUN mkdir -p /etc/apt/keyrings && \
    wget -q -O - https://repo.radeon.com/rocm/rocm.gpg.key | gpg --dearmor -o /etc/apt/keyrings/rocm.gpg && \
    echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/${ROCM_VERSION} jammy main" | \
    tee /etc/apt/sources.list.d/rocm.list

# Install ROCm full development suite
RUN apt-get update && apt-get install -y \
    rocm-dev \
    rocm-utils \
    hip-dev \
    hipcc \
    hipify-clang \
    rocm-llvm \
    rocm-cmake \
    rocm-smi-lib \
    rocprofiler-dev \
    roctracer-dev \
    && rm -rf /var/lib/apt/lists/*

# Set ROCm environment variables
ENV PATH=/opt/rocm/bin:/opt/rocm/llvm/bin:${PATH}
ENV LD_LIBRARY_PATH=/opt/rocm/lib:${LD_LIBRARY_PATH}
ENV HIP_PATH=/opt/rocm/hip
ENV ROCM_PATH=/opt/rocm
ENV HIP_PLATFORM=amd
ENV CHAI_HIP_LIB=/opt/rocm/lib
ENV CHAI_HIP_INC=/opt/rocm/include

# Create workspace
WORKDIR /workspace

# Install testing utilities
RUN pip3 install --no-cache-dir \
    pytest \
    pytest-benchmark \
    tabulate \
    colorama

# Create build and test scripts
RUN echo '#!/bin/bash\n\
# Compile all benchmarks\n\
set -e\n\
\n\
echo "CHAI HIP Compilation Test"\n\
echo "========================="\n\
echo "ROCm Version: $(hipcc --version | head -1)"\n\
echo ""\n\
\n\
BENCHMARKS=(BFS BS CEDD CEDT HSTI HSTO PAD RSCD RSCT SC SSSP TQ TQH TRNS)\n\
SUCCESS=0\n\
FAILED=0\n\
\n\
for bench in "${BENCHMARKS[@]}"; do\n\
    echo "Building $bench..."\n\
    cd /workspace/HIP-D/$bench\n\
    \n\
    if make -f Makefile.hip clean > /dev/null 2>&1 && \n\
       make -f Makefile.hip 2>&1 | tee build.log; then\n\
        echo "  ✓ $bench compiled successfully"\n\
        ((SUCCESS++))\n\
    else\n\
        echo "  ✗ $bench compilation failed"\n\
        echo "  See HIP-D/$bench/build.log for details"\n\
        ((FAILED++))\n\
    fi\n\
    \n\
    cd /workspace\n\
done\n\
\n\
echo ""\n\
echo "========================="\n\
echo "Compilation Results:"\n\
echo "  Success: $SUCCESS"\n\
echo "  Failed:  $FAILED"\n\
echo "  Total:   $((SUCCESS + FAILED))"\n\
echo "========================="\n\
\n\
if [ $FAILED -eq 0 ]; then\n\
    echo "All benchmarks compiled successfully!"\n\
    exit 0\n\
else\n\
    echo "Some benchmarks failed to compile."\n\
    exit 1\n\
fi\n\
' > /usr/local/bin/compile_all.sh && chmod +x /usr/local/bin/compile_all.sh

RUN echo '#!/bin/bash\n\
# Run quick smoke tests\n\
set -e\n\
\n\
echo "CHAI HIP Smoke Tests"\n\
echo "===================="\n\
echo ""\n\
\n\
BENCHMARKS=(BFS BS CEDD CEDT HSTI HSTO PAD RSCD RSCT SC SSSP TQ TQH TRNS)\n\
PASSED=0\n\
FAILED=0\n\
SKIPPED=0\n\
\n\
for bench in "${BENCHMARKS[@]}"; do\n\
    bench_lower=$(echo "$bench" | tr "[:upper:]" "[:lower:]")\n\
    echo "Testing $bench..."\n\
    cd /workspace/HIP-D/$bench\n\
    \n\
    if [ ! -f "$bench_lower" ]; then\n\
        echo "  ⊘ Binary not found (not compiled)"\n\
        ((SKIPPED++))\n\
        cd /workspace\n\
        continue\n\
    fi\n\
    \n\
    # Test with minimal arguments\n\
    if timeout 30s ./$bench_lower -h > /dev/null 2>&1; then\n\
        echo "  ✓ Help command works"\n\
        ((PASSED++))\n\
    else\n\
        echo "  ✗ Help command failed"\n\
        ((FAILED++))\n\
    fi\n\
    \n\
    cd /workspace\n\
done\n\
\n\
echo ""\n\
echo "===================="\n\
echo "Test Results:"\n\
echo "  Passed:  $PASSED"\n\
echo "  Failed:  $FAILED"\n\
echo "  Skipped: $SKIPPED"\n\
echo "===================="\n\
\n\
exit 0\n\
' > /usr/local/bin/smoke_tests.sh && chmod +x /usr/local/bin/smoke_tests.sh

# Create profiling script
RUN echo '#!/bin/bash\n\
# Profile a benchmark with rocprof\n\
\n\
if [ $# -eq 0 ]; then\n\
    echo "Usage: profile_benchmark.sh <benchmark_name>"\n\
    echo "Example: profile_benchmark.sh BFS"\n\
    exit 1\n\
fi\n\
\n\
BENCH=$1\n\
bench_lower=$(echo "$BENCH" | tr "[:upper:]" "[:lower:]")\n\
\n\
cd /workspace/HIP-D/$BENCH\n\
\n\
if [ ! -f "$bench_lower" ]; then\n\
    echo "Error: Benchmark $BENCH not found or not compiled"\n\
    exit 1\n\
fi\n\
\n\
echo "Profiling $BENCH with rocprof..."\n\
rocprof --stats ./$bench_lower\n\
\n\
if [ -f results.stats.csv ]; then\n\
    echo ""\n\
    echo "Profile results saved to results.stats.csv"\n\
    cat results.stats.csv\n\
fi\n\
' > /usr/local/bin/profile_benchmark.sh && chmod +x /usr/local/bin/profile_benchmark.sh

# Set default command to interactive shell
CMD ["/bin/bash"]

# Add helpful message on container start
RUN echo 'echo "CHAI HIP Testing Container"' >> /root/.bashrc && \
    echo 'echo "=========================="' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "Available commands:"' >> /root/.bashrc && \
    echo 'echo "  compile_all.sh       - Compile all benchmarks"' >> /root/.bashrc && \
    echo 'echo "  smoke_tests.sh       - Run quick smoke tests"' >> /root/.bashrc && \
    echo 'echo "  profile_benchmark.sh - Profile a specific benchmark"' >> /root/.bashrc && \
    echo 'echo "  rocm-smi            - Check GPU status"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "Environment variables set:"' >> /root/.bashrc && \
    echo 'echo "  ROCM_PATH=$ROCM_PATH"' >> /root/.bashrc && \
    echo 'echo "  CHAI_HIP_LIB=$CHAI_HIP_LIB"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

LABEL maintainer="CHAI HIP Testing"
LABEL description="Development and testing container for CHAI HIP benchmarks"
LABEL rocm.version="${ROCM_VERSION}"
